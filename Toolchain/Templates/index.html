<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarkLeaf — MD-to-PDF Publisher</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- App Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='assets/logo_mark.svg', v=app_version) }}" type="image/svg+xml">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css', v=app_version) }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row min-vh-100">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="sidebar-content">
                    <div class="logo-section mb-3">
                        <img class="logo-img" src="{{ url_for('static', filename='assets/MarkPdfPublisher_logo_transparent.png', v=app_version) }}" alt="MarkPdfPublisher">
                    </div>
                    <div class="gradient-divider mb-4" aria-hidden="true"></div>

                    <!-- Template Settings (Eisvogel) -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0 text-uppercase small">Template Settings</h6>
                            <span id="activeTemplateBadge" class="badge bg-light text-dark">—</span>
                        </div>
                        <div id="eisvogelSettings" class="card card-body p-3 d-none">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <strong class="small text-uppercase text-muted">Eisvogel</strong>
                                <i class="fas fa-feather text-muted" data-bs-toggle="tooltip" data-bs-title="Template LaTeX con title page, logo e colori personalizzabili."></i>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="titlepageToggle" checked>
                                <label class="form-check-label" for="titlepageToggle">Title page <i class="fas fa-circle-info ms-1 text-muted" data-bs-toggle="tooltip" data-bs-title="Abilita la copertina con titolo, autore, data e logo."></i></label>
                            </div>
                            <div class="mb-3">
                                <label for="logoWidth" class="form-label small mb-1">Logo width <i class="fas fa-circle-info ms-1 text-muted" data-bs-toggle="tooltip" data-bs-title="Esempi: 35mm, 120pt."></i></label>
                                <input type="text" class="form-control form-control-sm" id="logoWidth" placeholder="35mm">
                                <div class="invalid-feedback">Usa un valore tipo 35mm, 10pt, 3.5cm, 1.2in.</div>
                                <small class="text-muted">Suggerimento: 35–45mm su loghi orizzontali.</small>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="titlepageColor" class="form-label small mb-1">Title page color</label>
                                    <input type="color" class="form-control form-control-color" id="titlepageColor" value="#ffffff">
                                </div>
                                <div class="col-6">
                                    <label for="titlepageTextColor" class="form-label small mb-1">Title text color</label>
                                    <input type="color" class="form-control form-control-color" id="titlepageTextColor" value="#5f5f5f">
                                </div>
                                <div class="col-6">
                                    <label for="titlepageRuleColor" class="form-label small mb-1">Rule color</label>
                                    <input type="color" class="form-control form-control-color" id="titlepageRuleColor" value="#435488">
                                </div>
                                <div class="col-6">
                                    <label for="tocColor" class="form-label small mb-1">TOC link color</label>
                                    <input type="color" class="form-control form-control-color" id="tocColor" value="#2e6bd3">
                                </div>
                            </div>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="colorLinksToggle" checked>
                                <label class="form-check-label" for="colorLinksToggle">Color links</label>
                            </div>
                            <div class="d-grid mt-2">
                                <button type="button" id="eisvogelDefaultsBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-rotate-left me-1"></i> Restore defaults
                                </button>
                            </div>
                        </div>
                        <div id="defaultTemplateSettings" class="card card-body p-2">
                            <small class="text-muted">No extra options for this template.</small>
                        </div>
                    </div>

                    <!-- Document Settings -->
                    <div class="mb-3">
                        <h6 class="mb-2 text-uppercase small">Document Settings</h6>
                        <div class="card card-body p-3">
                            <label class="form-label fw-bold small mb-1"><i class="fas fa-list-ul me-2"></i>Table of Contents</label>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="tocEnabled" checked>
                                <label class="form-check-label" for="tocEnabled">Enable Table of Contents</label>
                            </div>
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">
                                    <label for="tocDepth" class="col-form-label">Depth</label>
                                </div>
                                <div class="col-auto">
                                    <select id="tocDepth" class="form-select form-select-sm">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3" selected>3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <div class="container py-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card main-card">
                                <div class="card-header d-flex align-items-start justify-content-between">
                                    <h3 class="card-title mb-0">
                                        <i class="fas fa-upload me-2"></i>
                                        Crea Documento PDF
                                    </h3>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="form-check form-switch m-0">
                                            <input class="form-check-input" type="checkbox" id="themeToggle">
                                            <label class="form-check-label" for="themeToggle" title="Toggle dark mode">
                                                <i class="fas fa-moon"></i>
                                            </label>
                                        </div>
                                        <div class="d-flex align-items-center m-0">
                                            <label for="paletteSelect" class="me-2 text-muted small d-flex align-items-center gap-2">
                                                <span>Palette</span>
                                                <span class="palette-swatch" title="Current palette preview"></span>
                                            </label>
                                            <select id="paletteSelect" class="form-select form-select-sm">
                                                <option value="consulting" selected>Consulting (Blue)</option>
                                                <option value="executive">Executive (Light Blue)</option>
                                                <option value="neutral">Neutral (Gray)</option>
                                            </select>
                                        </div>
                                        <div class="d-flex align-items-center m-0">
                                            <label for="templateType" class="me-2 text-muted small">Template</label>
                                            <select class="form-select form-select-sm" id="templateType" name="templateType">
                                                <option value="consulting">Consulting (Premium)</option>
                                                <option value="classic" selected>Classic (Clean)</option>
                                                <option value="eisvogel">Eisvogel (LaTeX)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-4 pt-0 pb-3">
                                    <p class="card-subtitle text-muted mt-2 mb-0">
                                        Carica il file Markdown e, se vuoi, il logo: MarkLeaf impagina in PDF professionali con template premium.
                                    </p>
                                    <!-- Slim top progress bar -->
                                    <div id="topProgress" class="progress-slim d-none" aria-hidden="true"></div>
                                </div>

                                <div class="card-body">
                                    <!-- Mode Toggle -->
                                    <div class="d-flex justify-content-center mb-4">
                                        <div class="btn-group" role="group" aria-label="Generation Mode">
                                            <input type="radio" class="btn-check" name="generationMode" id="uploadMode" autocomplete="off" checked>
                                            <label class="btn btn-outline-primary" for="uploadMode"><i class="fas fa-upload me-2"></i>Upload Mode</label>

                                            <input type="radio" class="btn-check" name="generationMode" id="localPathMode" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="localPathMode"><i class="fas fa-folder-open me-2"></i>Local Path Mode</label>
                                        </div>
                                    </div>

                                    <!-- Error Alert -->
                                    <div id="errorAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="errorMessage"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>

                                    <!-- Success Alert -->
                                    <div id="successAlert" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span id="successMessage"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>

                                    <!-- Upload Mode Form -->
                                    <div id="uploadFormContainer">
                                        <!-- Markdown File Upload -->
                                        <div class="mb-4">
                                            <label for="markdownFile" class="form-label fw-bold">
                                                <i class="fab fa-markdown me-2"></i>
                                                Markdown Document <span class="text-danger">*</span>
                                            </label>
                                            <div class="upload-area" id="markdownUploadArea">
                                                <div class="upload-content">
                                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                                    <p class="upload-text">
                                                        Drag and drop your .md file here or
                                                        <span class="text-primary fw-bold">click to browse</span>
                                                    </p>
                                                    <small class="text-muted">Only .md files are accepted</small>
                                                </div>
                                                <input type="file" class="form-control d-none" id="markdownFile" name="markdownFile" accept=".md" required>
                                            </div>
                                            <div id="markdownFileInfo" class="file-info mt-2 d-none">
                                                <i class="fas fa-file-text me-2"></i>
                                                <span class="file-name"></span>
                                                <span class="file-size text-muted ms-2"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Logo File Upload -->
                                        <div class="mb-4">
                                            <label for="logoFile" class="form-label fw-bold">
                                                <i class="fas fa-image me-2"></i>
                                                Logo Image <span class="text-muted">(Optional)</span>
                                            </label>
                                            <div class="upload-area" id="logoUploadArea">
                                                <div class="upload-content">
                                                    <i class="fas fa-image upload-icon"></i>
                                                    <p class="upload-text">
                                                        Drag and drop your logo here or
                                                        <span class="text-primary fw-bold">click to browse</span>
                                                    </p>
                                                    <small class="text-muted">PNG, SVG, PDF, JPG formats accepted</small>
                                                </div>
                                                <input type="file" class="form-control d-none" id="logoFile" name="logoFile" accept=".png,.svg,.pdf,.jpg,.jpeg">
                                            </div>
                                            <div id="logoFileInfo" class="file-info mt-2 d-none">
                                                <i class="fas fa-image me-2"></i>
                                                <span class="file-name"></span>
                                                <span class="file-size text-muted ms-2"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Local Path Mode Form -->
                                    <div id="localPathFormContainer" class="d-none">
                                        <div class="mb-3">
                                            <label for="localMarkdownPath" class="form-label fw-bold">Absolute Path to Markdown File <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="localMarkdownPath" placeholder="/path/to/your/document.md" required>
                                            <div class="form-text">The server must have read/write access to this path.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="localLogoPath" class="form-label fw-bold">Absolute Path to Logo File <span class="text-muted">(Optional)</span></label>
                                            <input type="text" class="form-control" id="localLogoPath" placeholder="/path/to/your/logo.png">
                                        </div>
                                        <div class="d-flex gap-2">
                                             <button type="button" class="btn btn-primary btn-lg" id="generateBtnLocal">
                                                <span class="btn-text">
                                                    <i class="fas fa-file-pdf me-2"></i>
                                                    Generate PDF Locally
                                                </span>
                                                <span class="btn-loading d-none">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    Processing...
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Instructions (collapsible ghost card) -->
                            <div class="card card-ghost mt-4" id="instructionsCard">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0 d-flex align-items-center gap-2">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Istruzioni</span>
                                    </h5>
                                    <button type="button" id="toggleInstructionsBtn" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#instructionsCollapse" aria-expanded="true" aria-controls="instructionsCollapse">
                                        <i class="fas fa-chevron-up me-1"></i> Nascondi
                                    </button>
                                </div>
                                <div id="instructionsCollapse" class="collapse show">
                                  <div class="card-body">
                                    <ol class="mb-0">
                                        <li class="mb-2">
                                            <strong>Carica Markdown:</strong> seleziona o trascina il tuo file .md con il contenuto.
                                        </li>
                                        <li class="mb-2">
                                            <strong>Aggiungi Logo (opzionale):</strong> carica un logo da includere in cover e intestazione.
                                        </li>
                                        <li class="mb-2">
                                            <strong>Genera PDF:</strong> premi su “Generate PDF” per creare il documento.
                                        </li>
                                        <li>
                                            <strong>Download:</strong> il PDF viene scaricato automaticamente al termine.
                                        </li>
                                    </ol>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- PDF.js local only -->
    <script>
      window.__PDFJS_WORKER__ = "{{ url_for('static', filename='js/vendor/pdfjs/pdf.worker.min.js') }}";
    </script>
    <script src="{{ url_for('static', filename='js/vendor/pdfjs/pdf.min.js') }}" defer></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header align-items-center gap-3">
                    <h5 class="modal-title m-0"><i class="fas fa-eye me-2"></i>Preview</h5>
                    <span id="previewPageCount" class="badge rounded-pill bg-light text-muted">–</span>
                    <span id="previewModeLabel" class="badge rounded-pill bg-secondary text-white" title="Modalità della preview">Semplice</span>

                    <!-- Compact toolbar -->
                    <div class="preview-toolbar btn-toolbar ms-auto" role="toolbar" aria-label="Preview toolbar">
                        <div class="btn-group me-2" role="group" aria-label="Modalità">
                            <button type="button" class="btn btn-ghost btn-sm active" id="modeSimpleBtn" data-bs-toggle="tooltip" data-bs-title="Modalità semplice: flip base">Semplice</button>
                            <button type="button" class="btn btn-ghost btn-sm" id="modeAdvancedBtn" data-bs-toggle="tooltip" data-bs-title="Modalità avanzata: doppia pagina, zoom, miniature">Avanzata</button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Effetto libro">
                            <button type="button" class="btn btn-ghost btn-sm active" id="bookEffectBtn" data-bs-toggle="tooltip" data-bs-title="Attiva/Disattiva animazione di sfoglio"><i class="fas fa-book-open me-1"></i><span class="d-none d-sm-inline">Libro</span></button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Layout" id="advancedGroup1">
                            <button type="button" class="btn btn-ghost btn-sm" id="spreadBtn" data-bs-toggle="tooltip" data-bs-title="Mostra due pagine affiancate"><i class="fas fa-columns me-1"></i><span class="d-none d-sm-inline">Doppia</span></button>
                        </div>
                        <div class="btn-group me-2 align-items-center" role="group" aria-label="Zoom" id="advancedGroup2">
                            <button type="button" class="btn btn-ghost btn-sm" id="zoomOutBtn" data-bs-toggle="tooltip" data-bs-title="Zoom -"><i class="fas fa-search-minus"></i></button>
                            <span class="zoom-label small text-muted px-1" id="zoomLevelLabel">100%</span>
                            <button type="button" class="btn btn-ghost btn-sm" id="zoomInBtn" data-bs-toggle="tooltip" data-bs-title="Zoom +"><i class="fas fa-search-plus"></i></button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Extra" id="advancedGroup3">
                            <button type="button" class="btn btn-ghost btn-sm active" id="soundBtn" data-bs-toggle="tooltip" data-bs-title="Suono pagina on/off"><i class="fas fa-volume-up me-1"></i><span class="d-none d-sm-inline">Suono</span></button>
                            <button type="button" class="btn btn-ghost btn-sm" id="thumbsBtn" data-bs-toggle="tooltip" data-bs-title="Mostra/Nascondi miniature"><i class="fas fa-images me-1"></i><span class="d-none d-sm-inline">Miniature</span></button>
                        </div>
                    </div>

                    <!-- Hidden form controls for state (kept for logic) -->
                    <input class="visually-hidden" type="checkbox" id="bookEffectToggle" checked>
                    <input class="visually-hidden" type="checkbox" id="advancedToggle">
                    <input class="visually-hidden" type="checkbox" id="spreadToggle">
                    <select id="zoomSelect" class="visually-hidden">
                        <option value="0.75">75%</option>
                        <option value="1" selected>100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                    </select>
                    <input class="visually-hidden" type="checkbox" id="soundToggle" checked>

                    <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="controls-legend small text-muted mb-2">
                        Navigazione: clic a <strong>destra</strong> per Avanti, a <strong>sinistra</strong> per Indietro • Frecce <strong>←/→</strong> • Trascina per sfogliare • Clicca sulle <strong>miniature</strong> per saltare alle pagine.
                    </div>
                    <div class="preview-wrapper d-flex justify-content-center">
                        <div id="previewPage" class="preview-page d-none"></div>
                        <iframe id="previewFrame" class="preview-frame" title="PDF Preview"></iframe>
                        <!-- Overlay nav hotspots -->
                        <button type="button" class="nav-hotspot left d-none" id="navHotspotLeft" aria-label="Pagina precedente" data-bs-toggle="tooltip" data-bs-title="Indietro (←)">
                            <i class="fas fa-chevron-left"></i>
                            <span class="label d-none d-sm-inline">Prec</span>
                        </button>
                        <button type="button" class="nav-hotspot right d-none" id="navHotspotRight" aria-label="Pagina successiva" data-bs-toggle="tooltip" data-bs-title="Avanti (→)">
                            <i class="fas fa-chevron-right"></i>
                            <span class="label d-none d-sm-inline">Avanti</span>
                        </button>
                    </div>
                    <div id="thumbsBar" class="thumbs-bar d-none" aria-label="Anteprime pagine"></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevPageBtn">
                            <i class="fas fa-chevron-left me-1"></i> Prev
                        </button>
                        <span id="flipPageIndicator" class="text-muted small">–</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextPageBtn">
                            Next <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
