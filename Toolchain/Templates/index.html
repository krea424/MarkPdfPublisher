<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarkLeaf — MD-to-PDF Publisher</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- App Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='assets/logo_mark.svg') }}" type="image/svg+xml">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row min-vh-100">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="sidebar-content">
                    <div class="logo-section text-center mb-3">
                        <img src="{{ url_for('static', filename='assets/logo_markleaf.svg') }}" alt="MarkLeaf" style="max-width: 220px; height: auto;">
                    </div>
                    <div class="gradient-divider mb-4" aria-hidden="true"></div>
                    
                    <div class="features-list">
                        <div class="feature-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Pandoc + XeLaTeX powered</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Professional templates</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Custom logo support</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Table of contents</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Headers and footers</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <div class="container py-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card main-card">
                                <div class="card-header d-flex align-items-start justify-content-between">
                                    <h3 class="card-title mb-0">
                                        <i class="fas fa-upload me-2"></i>
                                        Crea Documento PDF
                                    </h3>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="form-check form-switch m-0">
                                            <input class="form-check-input" type="checkbox" id="themeToggle">
                                            <label class="form-check-label" for="themeToggle" title="Toggle dark mode">
                                                <i class="fas fa-moon"></i>
                                            </label>
                                        </div>
                                        <div class="d-flex align-items-center m-0">
                                            <label for="paletteSelect" class="me-2 text-muted small d-flex align-items-center gap-2">
                                                <span>Palette</span>
                                                <span class="palette-swatch" title="Current palette preview"></span>
                                            </label>
                                            <select id="paletteSelect" class="form-select form-select-sm">
                                                <option value="consulting" selected>Consulting (Blue)</option>
                                                <option value="executive">Executive (Light Blue)</option>
                                                <option value="neutral">Neutral (Gray)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-4 pt-0 pb-3">
                                    <p class="card-subtitle text-muted mt-2 mb-0">
                                        Carica il file Markdown e, se vuoi, il logo: MarkLeaf impagina in PDF professionali con template premium.
                                    </p>
                                    <!-- Slim top progress bar -->
                                    <div id="topProgress" class="progress-slim d-none" aria-hidden="true"></div>
                                </div>
                                
                                <div class="card-body">
                                    <!-- Error Alert -->
                                    <div id="errorAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="errorMessage"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                    
                                    <!-- Success Alert -->
                                    <div id="successAlert" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span id="successMessage"></span>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                    
                                    <!-- Upload Form -->
                                    <form id="uploadForm" enctype="multipart/form-data">
                                        <!-- Markdown File Upload -->
                                        <div class="mb-4">
                                            <label for="markdownFile" class="form-label fw-bold">
                                                <i class="fab fa-markdown me-2"></i>
                                                Markdown Document <span class="text-danger">*</span>
                                            </label>
                                            <div class="upload-area" id="markdownUploadArea">
                                                <div class="upload-content">
                                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                                    <p class="upload-text">
                                                        Drag and drop your .md file here or 
                                                        <span class="text-primary fw-bold">click to browse</span>
                                                    </p>
                                                    <small class="text-muted">Only .md files are accepted</small>
                                                </div>
                                                <input type="file" class="form-control d-none" id="markdownFile" name="markdownFile" accept=".md" required>
                                            </div>
                                            <div id="markdownFileInfo" class="file-info mt-2 d-none">
                                                <i class="fas fa-file-text me-2"></i>
                                                <span class="file-name"></span>
                                                <span class="file-size text-muted ms-2"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Logo File Upload -->
                                        <div class="mb-4">
                                            <label for="logoFile" class="form-label fw-bold">
                                                <i class="fas fa-image me-2"></i>
                                                Logo Image <span class="text-muted">(Optional)</span>
                                            </label>
                                            <div class="upload-area" id="logoUploadArea">
                                                <div class="upload-content">
                                                    <i class="fas fa-image upload-icon"></i>
                                                    <p class="upload-text">
                                                        Drag and drop your logo here or 
                                                        <span class="text-primary fw-bold">click to browse</span>
                                                    </p>
                                                    <small class="text-muted">PNG, SVG, PDF, JPG formats accepted</small>
                                                </div>
                                                <input type="file" class="form-control d-none" id="logoFile" name="logoFile" accept=".png,.svg,.pdf,.jpg,.jpeg">
                                            </div>
                                            <div id="logoFileInfo" class="file-info mt-2 d-none">
                                                <i class="fas fa-image me-2"></i>
                                                <span class="file-name"></span>
                                                <span class="file-size text-muted ms-2"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Template Selection -->
                                        <div class="mb-4">
                                            <label for="templateType" class="form-label fw-bold">
                                                <i class="fas fa-palette me-2"></i>
                                                Template Style
                                            </label>
                                            <select class="form-select" id="templateType" name="templateType">
                                                <option value="consulting">Consulting Style (Premium design with gray table headers)</option>
                                                <option value="classic" selected>Classic Style (Clean and simple design)</option>
                                            </select>
                                            <small class="text-muted">
                                                <strong>Consulting:</strong> Professional design inspired by major consulting firms with enhanced table styling<br>
                                                <strong>Classic:</strong> Clean, simple design focused on readability
                                            </small>
                                        </div>

                                        <!-- TOC Options -->
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-list-ul me-2"></i>
                                                Table of Contents
                                            </label>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="tocEnabled" checked>
                                                <label class="form-check-label" for="tocEnabled">Enable Table of Contents</label>
                                            </div>
                                            <div class="row g-2 align-items-center">
                                                <div class="col-auto">
                                                    <label for="tocDepth" class="col-form-label">Depth</label>
                                                </div>
                                                <div class="col-auto">
                                                    <select id="tocDepth" class="form-select">
                                                        <option value="1">1</option>
                                                        <option value="2">2</option>
                                                        <option value="3" selected>3</option>
                                                        <option value="4">4</option>
                                                        <option value="5">5</option>
                                                    </select>
                                                </div>
                                                <div class="col">
                                                    <small class="text-muted">Controls how many heading levels appear in the TOC.</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-outline-secondary btn-lg" id="previewBtn" disabled>
                                                <span class="btn-text">
                                                    <i class="fas fa-eye me-2"></i>
                                                    Preview
                                                </span>
                                                <span class="btn-loading d-none">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    Rendering...
                                                </span>
                                            </button>
                                            <button type="submit" class="btn btn-primary btn-lg" id="generateBtn" disabled>
                                                <span class="btn-text">
                                                    <i class="fas fa-file-pdf me-2"></i>
                                                    Generate PDF
                                                </span>
                                                <span class="btn-loading d-none">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    Processing...
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Istruzioni
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0">
                                        <li class="mb-2">
                                            <strong>Carica Markdown:</strong> seleziona o trascina il tuo file .md con il contenuto.
                                        </li>
                                        <li class="mb-2">
                                            <strong>Aggiungi Logo (opzionale):</strong> carica un logo da includere in cover e intestazione.
                                        </li>
                                        <li class="mb-2">
                                            <strong>Genera PDF:</strong> premi su “Generate PDF” per creare il documento.
                                        </li>
                                        <li>
                                            <strong>Download:</strong> il PDF viene scaricato automaticamente al termine.
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- PDF.js local only -->
    <script>
      window.__PDFJS_WORKER__ = "{{ url_for('static', filename='js/vendor/pdfjs/pdf.worker.min.js') }}";
    </script>
    <script src="{{ url_for('static', filename='js/vendor/pdfjs/pdf.min.js') }}" defer></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header align-items-center gap-3">
                    <h5 class="modal-title m-0"><i class="fas fa-eye me-2"></i>Preview</h5>
                    <span id="previewPageCount" class="badge rounded-pill bg-light text-muted">–</span>
                    <span id="previewModeLabel" class="badge rounded-pill bg-secondary text-white" title="Modalità della preview">Semplice</span>
                    
                    <!-- Compact toolbar -->
                    <div class="preview-toolbar btn-toolbar ms-auto" role="toolbar" aria-label="Preview toolbar">
                        <div class="btn-group me-2" role="group" aria-label="Modalità">
                            <button type="button" class="btn btn-ghost btn-sm active" id="modeSimpleBtn" data-bs-toggle="tooltip" data-bs-title="Modalità semplice: flip base">Semplice</button>
                            <button type="button" class="btn btn-ghost btn-sm" id="modeAdvancedBtn" data-bs-toggle="tooltip" data-bs-title="Modalità avanzata: doppia pagina, zoom, miniature">Avanzata</button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Effetto libro">
                            <button type="button" class="btn btn-ghost btn-sm active" id="bookEffectBtn" data-bs-toggle="tooltip" data-bs-title="Attiva/Disattiva animazione di sfoglio"><i class="fas fa-book-open me-1"></i><span class="d-none d-sm-inline">Libro</span></button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Layout" id="advancedGroup1">
                            <button type="button" class="btn btn-ghost btn-sm" id="spreadBtn" data-bs-toggle="tooltip" data-bs-title="Mostra due pagine affiancate"><i class="fas fa-columns me-1"></i><span class="d-none d-sm-inline">Doppia</span></button>
                        </div>
                        <div class="btn-group me-2 align-items-center" role="group" aria-label="Zoom" id="advancedGroup2">
                            <button type="button" class="btn btn-ghost btn-sm" id="zoomOutBtn" data-bs-toggle="tooltip" data-bs-title="Zoom -"><i class="fas fa-search-minus"></i></button>
                            <span class="zoom-label small text-muted px-1" id="zoomLevelLabel">100%</span>
                            <button type="button" class="btn btn-ghost btn-sm" id="zoomInBtn" data-bs-toggle="tooltip" data-bs-title="Zoom +"><i class="fas fa-search-plus"></i></button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Extra" id="advancedGroup3">
                            <button type="button" class="btn btn-ghost btn-sm active" id="soundBtn" data-bs-toggle="tooltip" data-bs-title="Suono pagina on/off"><i class="fas fa-volume-up me-1"></i><span class="d-none d-sm-inline">Suono</span></button>
                            <button type="button" class="btn btn-ghost btn-sm" id="thumbsBtn" data-bs-toggle="tooltip" data-bs-title="Mostra/Nascondi miniature"><i class="fas fa-images me-1"></i><span class="d-none d-sm-inline">Miniature</span></button>
                        </div>
                    </div>

                    <!-- Hidden form controls for state (kept for logic) -->
                    <input class="visually-hidden" type="checkbox" id="bookEffectToggle" checked>
                    <input class="visually-hidden" type="checkbox" id="advancedToggle">
                    <input class="visually-hidden" type="checkbox" id="spreadToggle">
                    <select id="zoomSelect" class="visually-hidden">
                        <option value="0.75">75%</option>
                        <option value="1" selected>100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                    </select>
                    <input class="visually-hidden" type="checkbox" id="soundToggle" checked>

                    <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="controls-legend small text-muted mb-2">
                        Navigazione: clic a <strong>destra</strong> per Avanti, a <strong>sinistra</strong> per Indietro • Frecce <strong>←/→</strong> • Trascina per sfogliare • Clicca sulle <strong>miniature</strong> per saltare alle pagine.
                    </div>
                    <div class="preview-wrapper d-flex justify-content-center">
                        <div id="previewPage" class="preview-page d-none"></div>
                        <iframe id="previewFrame" class="preview-frame" title="PDF Preview"></iframe>
                        <!-- Overlay nav hotspots -->
                        <button type="button" class="nav-hotspot left d-none" id="navHotspotLeft" aria-label="Pagina precedente" data-bs-toggle="tooltip" data-bs-title="Indietro (←)">
                            <i class="fas fa-chevron-left"></i>
                            <span class="label d-none d-sm-inline">Prec</span>
                        </button>
                        <button type="button" class="nav-hotspot right d-none" id="navHotspotRight" aria-label="Pagina successiva" data-bs-toggle="tooltip" data-bs-title="Avanti (→)">
                            <i class="fas fa-chevron-right"></i>
                            <span class="label d-none d-sm-inline">Avanti</span>
                        </button>
                    </div>
                    <div id="thumbsBar" class="thumbs-bar d-none" aria-label="Anteprime pagine"></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevPageBtn">
                            <i class="fas fa-chevron-left me-1"></i> Prev
                        </button>
                        <span id="flipPageIndicator" class="text-muted small">–</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextPageBtn">
                            Next <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
